#!/bin/bash

set -e

netscape=~/.netscape/bookmarks.html
galeon=~/.galeon/bookmarks.xbel

if ps -uxww | grep -v grep | grep -q netscape; then
  echo "Can't normalize $netscape while netscape running."
else
  if [ -e $netscape ]; then
    echo -n "Normalizing Netscape bookmarks ... "
    perl -pi -e '
      s/ +LAST_VISIT="\d+"//g;
      s/<H3 (FOLDED )?/<H3 FOLDED /g unless />Toolbar</;
    ' $netscape
    echo "done."
  else
    echo "$netscape didn't exist."
  fi
fi

if ps -uxww | grep -v grep | grep -q galeon; then
  echo "Can't safely normalize $galeon while galeon running."
elif mount | grep -q "$HOME type nfs"; then
  echo "Can't safely normalize $galeon on NFS share."
else
  if [ -e $galeon ]; then
    echo -n "Normalizing galeon XBEL bookmarks ... "
    perl -ni -e '
      s/<folder folded="no">/<folder folded="yes">/g;
      print unless m!^\s*<time_(visited|modified)>\d+</time_\1>\s*!;
    ' $galeon
    echo "done."
  else
    echo "$galeon didn't exist."
  fi
fi  

